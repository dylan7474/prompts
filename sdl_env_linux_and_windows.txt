#!/usr/bin/env bash
set -euxo pipefail

echo "== Updating apt and installing base packages =="
apt-get update
apt-get install -y \
    build-essential make gcc g++ pkg-config \
    mingw-w64 \
    libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
    libcurl4-openssl-dev \
    ca-certificates git wget xxd unzip wine

echo "== Preparing Windows cross-compile SDL2 core =="
cd /tmp
wget -q https://github.com/libsdl-org/SDL/releases/download/release-2.30.4/SDL2-2.30.4.tar.gz
tar -xzf SDL2-2.30.4.tar.gz
cd SDL2-2.30.4
./configure --host=x86_64-w64-mingw32 --prefix=/usr/x86_64-w64-mingw32
make -j"$(nproc)"
make install
cd /tmp

echo "== Installing SDL2_image, SDL2_mixer, SDL2_ttf for MinGW =="
wget -q https://github.com/libsdl-org/SDL_image/releases/download/release-2.8.2/SDL2_image-devel-2.8.2-mingw.tar.gz
wget -q https://github.com/libsdl-org/SDL_mixer/releases/download/release-2.8.1/SDL2_mixer-devel-2.8.1-mingw.tar.gz
wget -q https://github.com/libsdl-org/SDL_ttf/releases/download/release-2.22.0/SDL2_ttf-devel-2.22.0-mingw.tar.gz

for a in *.tar.gz; do
    tar -xzf "$a"
done

cp -r SDL2_image*/x86_64-w64-mingw32/* /usr/x86_64-w64-mingw32/ || true
cp -r SDL2_mixer*/x86_64-w64-mingw32/* /usr/x86_64-w64-mingw32/ || true
cp -r SDL2_ttf*/x86_64-w64-mingw32/* /usr/x86_64-w64-mingw32/ || true

echo "== Building static libcurl for MinGW =="
wget -q https://curl.se/download/curl-8.8.0.tar.gz
tar -xzf curl-8.8.0.tar.gz
cd curl-8.8.0
./configure --host=x86_64-w64-mingw32 --prefix=/usr/x86_64-w64-mingw32 \
  --with-schannel --disable-shared --enable-static --disable-ldap --disable-ldaps
make -j"$(nproc)"
make install

echo "== Build environment ready for Linux + Windows cross-compilation =="
